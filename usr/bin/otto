#!/usr/bin/env sh
# vim: noai:ts=4:sw=4:expandtab

# Otto-PKG - Ein Paketmanager, der Pakete über BitTorrent herunterlädt.

# BSD 2-Clause License

# Copyright (c) 2019-2020, Luiz Antônio Rangel et Projeto Pindorama
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
# 1. Redistributions of source code must retain the above copyright notice, this
#    list of conditions and the following disclaimer.
#
# 2. Redistributions in binary form must reproduce the above copyright notice,
#    this list of conditions and the following disclaimer in the documentation
#    and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

# Dependências:
# Python 3.[4,8]
# Libtorrent and Libtorrent bindings for Python 3.x
# CURL
# POSIX 7-Zip (p7zip)

# TO DO:
# Terminar as funções pelo menos.
# Otimizar o máximo possível.

##############################################
# "Settar" algumas variáveis para uma execução "perfeita"  do Otto:
## Exportar as duas variaveis de linguagem como "C" (inglês), para maior performance e velocidade do script. Por isso, acentos não serão usados no output do programa.
export LANG=C
export LC_ALL=C

## Exportar o alias para o chdir
# Isso deve ser comentado em Shells que já tenham o chdir como comando nativo.
alias chdir='cd'

## Especificações do Otto no código do Otto:
export PROG='Otto'
export VER='1.0.0'
export PKG_FORMT='.psl'
export INDEXFILE='.otidx'
export PKG_COMPSS='7z'
export OTTOETC='/etc/otto'
export HOST_OS=${HKERNEL}

############## Include Files ##############
. /usr/lib/otto/colors.i
. /usr/lib/otto/txtampel.i
. /usr/lib/otto/posix-alt.i

# Carregar biblioteca de variáveis externas, do sistema e do usuário
# configuradas já na instalação do sistema ou do Otto em si caso for possível:
if [ -f "$OTTOETC/make.cfg" ]; then
	. "$OTTOETC/make.cfg"
else
	printf "${RED}make.cfg not found!$END\n"
	printf "${YELLOW}Copy this file from the installation media (or download it from the offcial repo) and configure it.$END\n"
    exit 1
fi
############## Script Functions ##############

chkroot(){
if [ $(id -u) -ne 0 ]; then
    printf "It's looks like that you isn't logged in toor nor root user...\n"
    printf "Would you like to install the program on the highest userland layer ($HIUSR) instead of installing directly on the root of the system [Y/N]?\n"
    read antworten
    if echo "$antworten" | grep -iq "^n" ;then
    printf "Alright, exiting."
    exit 130
    else
	export USRDIR=${HIUSR}
	export USRBIN=${HIUSRBIN}
    fi
else
    export USRDIR=${LOUSR}
    export USRBIN=${LOUSRBIN}
fi
}

params(){
if [ -z "$1" ]; then
    printf "${RED}ERROR:$END Insufficient parameters.\n"
    exit 127
fi
}

chkdsk(){
# Really bad functions made to take the disk space value, change it later.
    VERFDSK=$(df -h -m / | tail -1 | grep '[0-9]''[G,%]' | cut --delimiter=" " -f '14')
    BENUTZT=$(df -h / | tail -1 | grep '[0-9]''[G,%]' | cut --delimiter=" " -f '11')
    GROSSEDSK=$(df -h / | tail -1 | grep '[0-9]''[G,%]' | cut --delimiter=" " -f '8')
    
}

uncompress(){
    ampel=(
	"Extracting $PKGNM$PKG_FORMT."
	"Extracting $PKGNM$PKG_FORMT.."
	"Extracting $PKGNM$PKG_FORMT..."
    )

    txtampel &
    /usr/bin/7z x "$SRCDIR/$PKGNM$PKG_FORMT" -bb1
    kill $AMPID
}

build(){
    
}

autoclean(){
    printf "Autocleaning...\n" ; rm -ri "$SRCDIR/old/*"
}

pkgdown(){
    for torrent in "$@"; do
	PKGNM=$(printf "$torrent\n" | cut -d "/" -f 2)
	/usr/bin/otto-torrent -s -f "/usr/otto/db/$torrent.otlink" -d $SRCDIR
    done
}

# Rewrite this.
#install(){
#    params && chkroot && pkgdown
#    printf "Extracting $PKGNM$PKG_FORMT...\n"
#    /usr/bin/7z x "$SRCDIR/$PKGNM$PKG_FORMT" -bb1
#    chdir $SRCDIR
#    DIRLIST=$(ls)
#    for dir in $DIRLIST; do
#        FIRSTDIR=$(printf "$dir\n" | tr -d '$PKG_FORMT' | awk '{print $1}')
#        chdir $FIRSTDIR
#        compile
#        printf "${GREEN}Final size of the build tree: $(du -sh .)$END"
#        chdir ..
#    done
#    chdir $SRCDIR; mkdir -p old; mv * old
#    printf "$PKGNM" >> $PKGDIR/package.installed
#    [ $AUTOCLEAN = YES ] && autoclean
#    exit 0
#}

install(){
    
}

remove(){
    params && chkroot
    printf "${RED}ERROR:$END function not ready yet.\n"
    exit 1
}

update(){
    chkroot
    chdir $OTTOETC
    curl -OD -# "$MIRROR/pkgindex$INDEXFILE"
    $PKG_COMPSS x "pkgindex$INDEXFILE"
    printf "Package index updated.\n"
    exit 0
}

mkpkg(){
    
}

list(){
if [ -f "$OTTOETC/package.installed" ]; then
    pcat "$OTTOETC/package.installed"
    lines "$OTTOETC/package.installed"
    printf '%s\n' "$lines installed packages."
    exit 0
else
    printf "${RED}ERROR:$END package list not found, creating a empty file now.\n"
    > $OTTOETC/package.installed 
    exit 1
fi
}

info(){ printf "\
Otto $VER
Paketformat $PKG_FORMT
Betriebssystem: $HOST_OS

Copyright (c) 2019-2020 Luiz Antonio Rangel, Caio Novais et Project Pindorama.
"
exit 0
}

help(){ printf "\
${GREEN}Otto $VER, ein paketmanager.$END

> help    - Show this help message.
> info    - List info about the software.
> find    - Search for content in Otto's files.
> dig     - Install package.
> bury    - Remove package.
> up2date - Update repository index and packages.
> mkpkg   - Build a package (using source code or binaries). 
> list    - List installed packages.
"
exit 0
}

find(){
    params
    grep "$1" $(which otto) "$OTTOETC/make.cfg"
    exit 0
}

############## FIM DAS FUNCOES ################

############## CASE DO SCRIPT #################
case $1 in
	help*) help "$2" ;;
	info*) info "$2" ;;
        find*) find "$2" ;;
	dig*) install "$2" ;;
	bury*) remove "$2" ;;
	up2date*) update "$2" ;;
	mkpkg*) mkpkg "$2" ;;
        list*) list "$2" ;;
	*) help "$2" ;;
esac
############## FIM DO CASE ####################

