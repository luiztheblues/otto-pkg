#!/usr/bin/env sh
# vim: noai:ts=4:sw=4:expandtab
# shellcheck disable=SC1090,SC1091,SC2006,SC2059

# Otto-PKG - Ein Paketmanager, der Pakete über BitTorrent herunterlädt.

# BSD 2-Clause License
# Copyright (c) 2019-2020, Luiz Antônio Rangel et Projeto Pindorama
# Read LICENSE @ master branch root (GitHub) for the complete license.

#############    Depends    ###############
# Python 3.(4,8);
# Libtorrent and Libtorrent bindings for Python 3.x;
# cURL;
# POSIX 7-Zip (p7zip);
# Otto's libaries.
##############     END       ##############

# TO DO:
# Terminar as funções pelo menos;
# Otimizar o máximo possível;
# Make it portable;
# Fix identation  (tab = two spaces);
# Write the install() function;
# Write the remove() function (and finish others!);
# Implement raw/-r option (and function!) for installing/removing/updating packages via an .psl file;
# Fix lib txtampel;
# Fix chkparams().

############# Export C locale #############
export LANG=C
export LC_ALL=${LANG}
##############     END       ##############

############# Export chdir alias ##########
# This shall be commented when /bin/sh already has a native "chdir" command/system call, for example zsh.
alias chdir='cd'
##############     END       ##############

############# Program Specifications ######
export PROG='Otto'
export VER='0.1'
export PKG_FORMT='.psl'
export INDEXFILE='.otidx'
export PKG_COMPSS='7z'
export OTTOETC='/etc/otto'
export HOST_OS=${HKERNEL}
##############     END       ##############

############## Include Files  ##############
. /usr/lib/otto/colors.shi
. /usr/lib/otto/blink.shi
. /usr/lib/otto/txtampel.shi
. /usr/lib/otto/txtwait.shi
. /usr/lib/otto/posix-alt.shi
##############     END       ##############

# Load the configuration file:
  if [ -f "$OTTOETC/make.cfg" ]; then
    . "$OTTOETC/make.cfg"
  else
    printf "${RED}ERROR$END: make.cfg not found!\n ${YELLOW}Copy this file from the installation media (or download it from the offcial repo) and configure it.$END\n"
  exit 1
  fi

############## Script Functions ##############

############## ARE YA CHECKING SON? #########
chkroot(){
  if [ `id -u` -ne 0 ]; then
    printf "It looks like you are not logged into ${YELLOW}toor$END nor ${RED}root$END user...\nWould you like to install the program on the highest userland layer ($HIUSR) instead of installing directly on the root of the system?\n${BLK_RED}WARNING$END: Some packages ${RED}cannot$END be installed on the highest userland layer ${RED}under any circunstances$END.\n[${GREEN}Y$END/${RED}N$END]? "
    read -r ANTWORTEN
    if echo "$ANTWORTEN" | grep -iq "^y" ;then
      export USRDIR=${HIUSR}
      export USRBIN=${HIUSRBIN}
      export ETC=${HIETC}
    else
      printf "Alright so, exiting...\n"
      exit 130
    fi
  else
    export USRDIR=${LOUSR}
    export USRBIN=${LOUSRBIN}
    export ETC=${LOETC}
  fi
}

chknet(){
  printf "Checking network connection"
  txtwait
  if  printf "GET luiznet.tk HTTP/1.0\n\n" | timeout 12 netcat luiznet.tk 80 > /dev/null 2>&1
  then
    printf "[ ${GREEN}OK$END ]\n"
  else
    printf "[ ${RED}FAILED$END ]\n"
    printf "${RED}ERROR$END: Apparently, this box ${RED}isn't connected$END to the World Wide Web.\a\nIf you don't have a internet connection, try to download the raw package (a ${YELLOW}$PKG_FORMT$END which contains the source-code/program files and a build/install file), save it in a diskette/CD/SDCard/USB and install it using ${YELLOW}otto dig [raw|-r]$END.\nIf you expected to have networking on this box, ${BLK_RED}do some checks$BLK_END. Check if the network daemon is running, if the drivers are enabled on the Kernel and if the physical devices are even working/turned on.\n"
    exit 1
  fi
}

chkparams(){
  if [ -z "$@" ]; then
    printf "${RED}ERROR$END: Insufficient parameters.\n"
    exit 127
  fi
}

chkdsk(){
  set -A DSKFUNC 8 11 14
  BENUTZT=${DSKFUNC[1]} # Benutzt disk (used disk)
  VERFDSK=${DSKFUNC[2]} # Verfügbar disk (avaible disk)
  GROSSEDSK=${DSKFUNC[0]} # disk Größe (disk size)
  CHKDSK_PIPELINE=`df -h / | tail -1 | grep '[0-9]''[G,%]' | cut --delimiter=" " -f`
}

##############  Sure i am, dad.  ############

uncompress(){
  set -A AMPEL "Extracting $PKGNM$PKG_FORMT." "Extracting $PKGNM$PKG_FORMT.."  "Extracting $PKGNM$PKG_FORMT..."
  txtampel
  /usr/bin/7z x "$SRCDIR/$PKGNM$PKG_FORMT" -bb1
  kill "$AMPID"
}

build(){
  sh "$PKGNM".otbuild
}

autoclean(){
  printf "Autocleaning...\n" ; rm -ri "$SRCDIR/old/*"
}

pkgdown(){
  if [ "$SYNC_TYPE" -eq "bittorrent" ]
  then
    for TORRENT in "$@"; do
      PKGNM=`printf "$TORRENT\n" | cut -d "/" -f 2`
      /usr/bin/pico-torrent -s -f "/usr/otto/db/$TORRENT/pkgp2p" -d "$SRCDIR"
    done
  elif [ "$SYNC_TYPE" -eq "http" -o "$SYNC_TYPE" -eq "ftp" ]
  then
    for PKG in "$@"; do
      PKGNM=`printf "$PKG\n" | cut -d "/" -f 2`
      /usr/bin/curl -# -O `cat "/usr/otto/db/$PKG/pkglink"`
    done
  else
    printf "${RED}ERROR$END: SYNC_TYPE not set @ $OTTOETC/make.cfg.\n"
 fi

}

# Rewrite this.
#install(){
#    params && chkroot && pkgdown
#    printf "Extracting $PKGNM$PKG_FORMT...\n"
#    /usr/bin/7z x "$SRCDIR/$PKGNM$PKG_FORMT" -bb1
#    chdir $SRCDIR
#    DIRLIST=$(ls)
#    for dir in $DIRLIST; do
#        FIRSTDIR=$(printf "$dir\n" | tr -d '$PKG_FORMT' | awk '{print $1}')
#        chdir $FIRSTDIR
#        compile
#        printf "${GREEN}Final size of the build tree: $(du -sh .)$END"
#        chdir ..
#    done
#    chdir $SRCDIR; mkdir -p old; mv * old
#    printf "$PKGNM" >> $PKGDIR/package.installed
#    [ $AUTOCLEAN = YES ] && autoclean
#    exit 0
#}

install(){
  uncompress
  build

}

remove(){
  printf "${RED}ERROR:$END function not ready yet.\n"
  exit 1
}

update(){
  chkroot
  chdir $OTTOETC
  curl -OD -# "$MIRROR/pkgindex$INDEXFILE"
  $PKG_COMPSS x "pkgindex$INDEXFILE"
  printf "Package index updated.\n"
  exit 0
}

mkpkg(){
  printf "${RED}ERROR:$END function not ready yet.\n"
  exit 1
}

list(){
  if [ -f "$OTTOETC/package.installed" ]; then
    pcat "$OTTOETC/package.installed"
     lines "$OTTOETC/package.installed"
    printf '%s\n' "$lines installed packages."
    exit 0
  else
    printf "${BLK_RED}ERROR:$BLK_END package list not found!.\a\n"
    exit 140
  fi
}

info(){ printf "\
Otto-PKG $VER
Paketformat $PKG_FORMT
Betriebssystem: $HOST_OS

Copyright (c) 2019-2020 Luiz Antonio Rangel, Caio Novais et Project Pindorama.

lib-txtampel und lib-posixalt (@ ${LOUSR}/lib/otto)
Copyright (c) 2019-2020 Jefferson Rocha et MazonOS Team.
Copyright (c) 2020 Luiz Antonio Rangel, Caio Novais et Project Pindorama.
"
exit 0
}

help(){
    export LANG=en_US.UTF-8
    export LC_ALL=${LANG}
    printf "\
${GREEN}Otto $VER, ein paketmanager.$END
${YELLOW}otto {-H|-I|-f|-d|-b|-u|-i|-l} <category>/<pkgs>| -r (-d|-b) <pkg>$PKG_FORMT$END
${GREEN}> help (-H)    - Show this help message.
> info (-I)    - List info about the software.
> find (-f)    - Search for content in Otto's files.
> dig  (-d)    - Install package.
> bury (-b)    - Remove package.
> up2date (-u) - Update repository index and packages.
> mkpkg (-i)   - Build a package (using source code or binaries).
> list  (-l)   - List installed packages.$END

✠ GOTT MIT UNS ✠
"
exit 0
}

find(){
    grep "$1" `which otto` "$OTTOETC/make.cfg"
    exit 0
}

##############     END      #################

############## CASE DO SCRIPT #################
case $1 in
    help|-H*) help ;;
    info|-I*) info ;;
    find|-f*) find "$@" ;;
    dig|-d*) chkroot && install "$@" ;;
    bury|-b*) chkparams && chkroot && remove "$@" ;;
    up2date|-u*) chkroot && update "$@" ;;
    mkpkg|-i*) chkroot && mkpkg "$2" ;;
    list|-l*) list "$@" ;;
    chknet*) chknet;;
    *) help ;;
esac
############## FIM DO CASE ####################
