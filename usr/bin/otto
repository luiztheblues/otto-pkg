#!/usr/bin/env ksh 
# Do arrays actually work on Ksh? I think that array bug is a Public Domain Ksh fault, may i try it on ksh93 later.
# Ok, i will remember to patch it later.
# shellcheck disable=SC1090,SC1091,SC2006,SC2059

# Otto-PKG - Ein Paketmanager, der Pakete über BitTorrent (und nun HTTP) herunterlädt.

# BSD 2-Clause License
# Copyright (c) 2019-2020, Luiz Antônio Rangel et Projeto Pindorama
# Read LICENSE @ master branch root (GitHub) for the complete license.

#############    Depends    ###############
# Python 3.(4,8);
# Libtorrent and Libtorrent bindings for Python 3.x;
# cURL;
# POSIX 7-Zip (p7zip);
# Otto's libaries.
##############     END       ##############

# TO DO:
# Terminar as funções pelo menos;
# Optimize it;
# Make it portable;
# Fix identation  (tab = two spaces);
# Write the remove() and install() function (and finish others!);
# Implement raw/-r option (and function!) for installing/removing/updating packages via an .psl file;
# Fix the inconsistent code style;
# Create a log function, for save every operation log in /var/otto/system/logs/otto_`date`. A little useless for now.

############# Export C locale #############
export LANG=C
export LC_ALL=${LANG}
##############     END       ##############

############# Export chdir alias ##########
# This shall be commented when /bin/sh already has a native "chdir" command/system call, for example zsh.
alias chdir='cd'
##############     END       ##############

############# Program Specifications ######
# Program Otto
# Version 0.3
export PKG_FORMT='.psl'
export INDEXFILE='.otidx'
export PKG_COMPSS='7z'
export HOST_OS=${HKERNEL}
##############     END       ##############

############## Include Files ##############
. /usr/lib/otto/colors.shi
. /usr/lib/otto/blink.shi
. /usr/lib/otto/txtwait.shi
. /usr/lib/otto/posix-alt.shi
##############     END       ##############

############## Global Variables/Subshells #
PKG_FILENAME=`sed 's/ /./g' <<< $NAME`

##############     END       ##############

# Load the configuration file:
  if [ -f "/etc/make.cfg" ]; then
    . "/etc/make.cfg"
  else
    printf "${RED}ERROR$END: make.cfg not found!\nCopy this file from the installation media (or download it from the offcial repo) and configure it.\n"
  exit 1
  fi

############## Script Functions ###########

############ ARE YA CHECKING SON? #########
Checkroot(){
  if [ "`id -u`" -ne 0 ]; then
    printf "${YELLOW}WARNING$END: It looks like you are not logged into toor nor root user...\nWould you like to install the program on the highest userland layer ($HIUSR) instead of installing directly on the root of the system?\n${YELLOW}WARNING$END: Some packages ${BOLD}cannot$END be installed on the highest userland layer under any circunstances.\nRegarding the first (and only) question: [Y,N]? "
    read -r ANTWORTEN
    if grep -iq '^y' <<< "$ANTWORTEN"; then
      export USRDIR=${HIUSR}
      export USRBIN=${HIUSRBIN}
      export ETC=${HIETC}
      export SRCDIR=${HISRCDIR}
      export DIRISTATE=2
    else
      printf "Alright so, exiting...\n"
      exit 130
    fi
  else
    export USRDIR=${LOUSR}
    export USRBIN=${LOUSRBIN}
    export ETC=${LOETC}
    export SRCDIR=${LOSRCDIR}
    export DIRISTATE=1
  fi
}

CheckNetwork(){
  printf "Checking network connection"
  txtwait
  if  `timeout 12 /usr/bin/netcat luiznet.tk 80 <<< "GET luiznet.tk HTTP/1.0\n\n" > /dev/null 2>&1`; then
    printf "[ ${GREEN}OK$END ]\n"
  else
    printf "[ ${RED}FAILED$END ]\n"
    printf "${RED}ERROR$END: Apparently, this box isn't connected to the World Wide Web.\a\nIf you don't have a internet connection, try to download the raw package (a ${YELLOW}$PKG_FORMT$END which contains everything necessary to install the program), save it in a diskette/CD/SDCard/USB and install it using ${YELLOW}otto dig [raw|-r]$END.\nIf you expected to have networking on this box, do some checks. Check if the network daemon is running, if the drivers are enabled on the Kernel and if the physical devices are even working/turned on.\n"
    exit 1
  fi
}

CheckParameters(){
  if [ -z "$2" ]; then
    printf "${RED}ERROR$END: Insufficient parameters.\n"
    exit 127
  fi
}

CheckDisk(){
  BENUTZT=`df -m / | tail -1 | grep '[0-9]' | awk '{print $3}'`
  DSKVERF=`df -m / | tail -1 | grep '[0-9]' | awk '{print $4}'`
  DSKGROSSE=$[$BENUTZT + $VERFDSK]
  PKGGROSSE_FILE=`du -sk $SRCDIR/$CATEGORY/$PKG_FILENAME$PKG_FORMT | awk '{print $1}'`
  PKGGROSSE_CALC=`bc <<< "scale=3; $PKGGROSSE_FILE/1000"`
  printf "\
Estimated total disk space: "$DSKGROSSE"MB
Estimated used space: "$VERFDSK"MB
Estimated space available: "$BENUTZT"MB
Estimated space to be consumed (build files): "$PKGGROSSE_CALC"MB
Estimated space after install: `bc <<< "'scale=3;' $DSKVERF - $PKGGROSSE_CALC"`MB
"  
}

CheckDependencies(){
  for DEPS in $DEPENDENCIES; do
    printf "I didn't finish this function yet, lol.\nIdk how to do it yet too... How can i check name-per-name @ /var/otto/installed/contents?\nGrep doesn't seems to work..."
   printf "FOUND A SOLUTION! I will write it later.\n" 
 done 
}

##############  Sure i am, dad.  ############

Uncompress(){
  printf "Extracting $PKG_FILENAME$PKG_FORMT"
  txtwait
  /usr/bin/7z x "$SRCDIR"/"$CATEGORY"/"$PKG_FILENAME""$PKG_FORMT" -bb1
}

Build(){
  /bin/sh "$SRCDIR"/"$PKGNM"/install/checkinstall
  /bin/sh "$SRCDIR"/"$PKGNM"/install/makebuild
}

GenerateLocalpkgmap(){
cat > /var/otto/installed/pkg/OTTO"$PKG"/pkgmap <<EOD
`cat "$SRCDIR"/"$PKGNM"/install/pkgmap`
EOD
} # This will load directory variables (ex: low /usr or high /usr?) for a specific install, in theory.

#GenerateLocalpkginfo(){
#cat > /var/otto/installed/pkg/OTTO"$PKG"/pkginfo <<EOD
#`cat "$SRCDIR"/"$PKGNM"/pkginfo`
#EOD
#}

AutoClean(){
  printf "Cleaning "$SRCDIR"/"$PKGNM" sources...\n" ; rm -rvi "$SRCDIR"/"$PKGNM"/"*"
}

DownwloadPackage(){
  printf "Packages to install: ${#@}\n"
  if [ "$SYNC_TYPE" = "bittorrent" ]
  then
    for TORRENT in "$@"; do
      PKGNM="$TORRENT"
      PKG=`printf "$TORRENT\n" | cut -d "/" -f 2`
      CATEGORY=`printf "$TORRENT\n" | cut -d "/" -f 1`
      . "$PKGDIR"/"$TORRENT"/pkginfo
      /usr/bin/pico-torrent -s -f "$PKGDIR"/"$TORRENT"/pkgp2p -d "$SRCDIR"
    done
  elif [ "$SYNC_TYPE" = "http" ] || [ "$SYNC_TYPE" = "ftp" ]
  then
    for PKGNM in "$@"; do
      PKG=`printf "$PKGNM\n" | cut -d "/" -f 2`
      CATEGORY=`printf "$PKGNM\n" | cut -d "/" -f 1`
      . "$PKGDIR/$PKGNM/pkginfo"
      /usr/bin/curl -# -O "`cat "$PKGDIR/$PKG/pkglink"`"
    done
  else
    printf "${RED}ERROR$END: SYNC_TYPE not set @ /etc/make.cfg.\n"
 fi

}

# Rewrite this.
#install(){
#    params && chkroot && pkgdown
#    printf "Extracting $PKGNM$PKG_FORMT...\n"
#    /usr/bin/7z x "$SRCDIR/$PKGNM$PKG_FORMT" -bb1
#    chdir $SRCDIR
#    DIRLIST=$(ls)
#    for dir in $DIRLIST; do
#        FIRSTDIR=$(printf "$dir\n" | tr -d '$PKG_FORMT' | awk '{print $1}')
#        chdir $FIRSTDIR
#        compile
#        printf "${GREEN}Final size of the build tree: $(du -sh .)$END"
#        chdir ..
#    done
#    chdir $SRCDIR; mkdir -p old; mv * old
#    printf "$PKGNM" >> $PKGDIR/package.installed
#    [ $AUTOCLEAN = YES ] && autoclean
#    exit 0
#}

InstallPackage(){
  . "$PKGDIR"/"$PKGNM"/pkginfo
  Uncompress
  Build
  mkdir /var/otto/installed/pkg/OTTO"$PKG"
  GenerateLocalpkgmap
# GenerateLocalpkginfo
  printf "$PKGNM  $VERSION\n" > /var/otto/installed/contents # I need to think of a better layout, but it will be this for while
}

RemovePackage(){
  for PKGNM in "$@"; do 
    PKG=`printf "$PKGNM\n" | cut -d "/" -f 2`
    CATEGORY=`printf "$PKGNM\n" | cut -d "/" -f 1`
    printf "Removing $CATEGORY/$PKG"
    < /var/otto/installed/pkg/OTTO"$PKG"/pkgmap /usr/bin/xargs rm -rv  # Wait, do this work? Really awesome to see that i didn't need that cat.
    sed -i "/$PKGNM/d" /var/otto/installed/contents
  done
}

Update(){
  chdir "$PKGDIR"
  /usr/bin/curl -OD -# "$MIRROR"/pkgindex"$INDEXFILE"
  /usr/bin/7z x pkgindex"$INDEXFILE"
  printf "Package index updated.\n"
  exit 0
}

#MakePackage(){
  
#}

ListPackages(){
  if [ -f "/var/otto/installed/contents" ]; then
     lines "/var/otto/installed/contents"
    printf '%s\n' "$lines installed packages."
    exit 0
  else
    printf "${BLK_RED}ERROR:$BLK_END package list not found! This isn't a good thing...\a\n"
    exit 140
  fi
}

Info(){ printf "\
Otto-PKG $VER
Paketformat $PKG_FORMT
Betriebssystem: $HOST_OS

Copyright (c) 2019-2020 Luiz Antonio Rangel, Caio Novais et Project Pindorama.

lib-txtampel und lib-posixalt (@ ${LOUSR}/lib/otto)
Copyright (c) 2019-2020 Jefferson Rocha et MazonOS Team.
Copyright (c) 2020 Luiz Antonio Rangel, Caio Novais et Project Pindorama.
"
exit 0
}

Help(){
    export LANG=en_US.UTF-8
    export LC_ALL=${LANG}
    printf "\
${GREEN}Otto, eine Paketverwaltungs-Toolchain.$END
${YELLOW}otto {-H|-I|-f|-d|-b|-u|-i|-l} <category>/<pkg>| -r (-d|-u|-b) <pkg>$PKG_FORMT$END
${GREEN}> help (-H)    - Show this help message.
> info (-I)    - List info about the software.
> find (-f)    - Search for content in Otto's files.
> dig  (-d)    - Install package.
> bury (-b)    - Remove package.
> up2date (-u) - Update repository index and packages.
> mkpkg (-i)   - Build a package (using source code or binaries).
> list  (-l)   - List installed packages.$END

✠ GOTT MIT UNS ✠
"
exit 0
}

find(){
    grep "$1" "`which otto`" "/etc/make.cfg"
    exit 0
}

##############     END      #################

############## CASE DO SCRIPT #################
case $1 in
    help|-H*) Help ;;
    info|-I*) Info ;;
    find|-f*) find "$@" ;;
    dig|-d*) Checkroot && InstallPackage "$@" ;;
    bury|-b*) CheckParameters "$@" && Checkroot && RemovePackage "$@" ;;
    up2date|-u*) Checkroot && Update "$@" ;;
    mkpkg|-i*) Checkroot && MakePackage "$2" ;;
    list|-l*) ListPackages "$@" ;;
    chknet*) CheckNetwork;;
    *) Help ;;
esac
############## FIM DO CASE ####################
